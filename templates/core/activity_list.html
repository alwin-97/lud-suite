{% extends 'base.html' %}
{% load static %}

{% block title %}{{ mentor.first_name }}'s Activity List{% endblock title %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
{% endblock links %}

{% block content %}
{% include 'partials/head.html' %}
<div class="container py-4">
            <div class="card mb-4">
                <div class="card-body">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item">
                                <a href="{% url 'endorser_dashboard' %}" class="text-decoration-none">Home</a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'activity_log' %}" class="text-decoration-none">Mentors Assigned</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Activity</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="fw-semibold mb-0">Activities by {{ mentor.first_name }} {{ mentor.last_name }}</h6>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="fw-semibold">Activity Entries</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="activityTable" class="table align-middle mb-0">
                            <thead class="table-light">
                                <tr class="text-center">
                                    <th>Date</th>
                                    <th>Activity</th>
                                    <th>Duration</th>
                                    <th>Learnings</th>
                                    <th>Feedback</th>
                                    <th>Photo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if activities %}
                                    {% for activity in activities %}
                                    <tr class="text-center">
                                        <td>{{ activity.date }}</td>
                                        <td>{{ activity.activity }}</td>
                                        <td>{{ activity.duration }}</td>
                                        <td>{{ activity.learnings }}</td>
                                        <td>{{ activity.feedback }}</td>
                                        <td>
                                            {% if activity.photo %}
                                            <a href="{{ activity.photo.url }}" target="_blank">
                                                <img src="{{ activity.photo.url }}" alt="Activity Photo"
                                                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                            </a>
                                            {% else %}
                                            <span class="text-muted">No photo</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if activity.remark %}
                                            <button class="btn btn-sm btn-success view-remark-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#viewRemarkModal"
                                                data-remark="{{ activity.remark|escapejs }}">
                                                Remarked
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-primary remark-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#remarkModal"
                                                data-activity-id="{{ activity.id }}">
                                                Unremarked
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center py-4">No activities found for this mentor.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if activities %}
            <div class="mt-3 text-end">
                <a href="{% url 'activity_log' %}" class="btn btn-outline-secondary">
                    <i class="fa-solid fa-arrow-left me-1"></i>Back to Mentors
                </a>
            </div>
            {% endif %}
</div>

<!-- Add Remark Modal -->
<div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="remarkForm" method="POST" action="{% url 'add_remark' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="remarkModalLabel">Add Remark</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="activity_id" id="activityIdInput">
                    <textarea class="form-control" name="remark" id="remarkText" rows="4"
                        placeholder="Enter your remark..." required></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Remark Modal -->
<div class="modal fade" id="viewRemarkModal" tabindex="-1" aria-labelledby="viewRemarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Remark</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="viewRemarkText" class="mb-0"></p>
            </div>
        </div>
    </div>
</div>

<!-- JS Includes -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        // Only initialize DataTable if activities exist
        {% if activities %}
        $('#activityTable').DataTable({
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            ordering: true,
            searching: true,
            info: true
        });
        {% endif %}

        // Capture clicked activity id
        $(document).on('click', '.remark-btn', function () {
            const activityId = $(this).data('activity-id');
            $('#activityIdInput').val(activityId);
        });

        // Submit remark via AJAX
        $('#remarkForm').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                url: $(this).attr('action'),
                method: 'POST',
                data: $(this).serialize(),
                success: function (response) {
                    $('#remarkModal').modal('hide');
                    const btn = $(`button[data-activity-id='${response.activity_id}']`);
                    btn.replaceWith(`
                        <button class="btn btn-sm btn-success view-remark-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#viewRemarkModal" 
                            data-remark="${response.remark}">
                            Remarked
                        </button>`);
                },
                error: function () {
                    alert('Error saving remark.');
                }
            });
        });

        // View remark
        $(document).on('click', '.view-remark-btn', function () {
            const remarkText = $(this).data('remark');
            $('#viewRemarkText').text(remarkText);
        });
    });
</script>
{% endblock content %}
