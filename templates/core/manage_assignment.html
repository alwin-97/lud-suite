{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Assignment{% endblock %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

{% endblock %}

{% block content %}
{% include 'partials/head.html' %}
<div class="container py-4">
  <div class="card mb-4">
    <div class="card-body">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item">
            <a href="{% url 'admin_dashboard' %}" class="text-decoration-none">Admin Dashboard</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Endorser-Mentor Assignment</li>
        </ol>
      </nav>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-body text-center">
      <h2 class="mb-0">Manage Endorser-Mentor Assignment</h2>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Unassigned Endorsers</div>
          <div class="fs-4 fw-semibold">{{ unassigned_endorsers.count }}/{{ total_endorsers }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center">
        <div class="card-body">
          <div class="text-muted text-uppercase small">Unassigned Mentors</div>
          <div class="fs-4 fw-semibold">{{ unassigned_mentors.count }}/{{ total_mentors }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span class="fw-semibold">Endorsers</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table id="endorsersTable" class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Endorser Name</th>
              <th>Email</th>
              <th>Assigned Mentors</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for data in endorsers_with_counts %}
            <tr>
              <td>{{ data.endorser.first_name }} {{ data.endorser.last_name }}</td>
              <td>{{ data.endorser.email }}</td>
              <td>{{ data.mentor_count }}</td>
              <td>
                <button class="btn btn-primary btn-sm assign-btn" data-bs-toggle="modal" data-bs-target="#assignModal"
                  data-endorser="{{ data.endorser.id }}"
                  data-endorser-name="{{ data.endorser.first_name }} {{ data.endorser.last_name }}">
                  <i class="fa-solid fa-link me-1"></i>Assign
                </button>

                <button class="btn btn-secondary btn-sm view-mentors-btn" data-bs-toggle="modal"
                  data-bs-target="#viewMentorsModal" data-endorser="{{ data.endorser.id }}"
                  data-endorser-name="{{ data.endorser.first_name }} {{ data.endorser.last_name }}">
                  <i class="fa-solid fa-eye me-1"></i>View Mentors
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="assignModalLabel">Assign Mentors</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="endorserNameModal" class="fw-semibold mb-3 text-primary"></p>
        <form id="assignForm">
          <input type="hidden" id="endorserId">

          <div class="mb-3">
            <label class="form-label">Select Mentors</label>
            <div class="list-group" id="mentorCheckboxList" style="max-height: 300px; overflow-y: auto;">
              {% for mentor in unassigned_mentors %}
              <label class="list-group-item d-flex align-items-center">
                <input class="form-check-input me-2" type="checkbox" name="mentor_ids" value="{{ mentor.id }}">
                {{ mentor.first_name }} {{ mentor.last_name }}
                <span class="text-muted ms-auto small">({{ mentor.email }})</span>
              </label>
              {% empty %}
              <p class="text-muted text-center">No unassigned mentors available.</p>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" id="saveAssignment">Save</button>
      </div>
    </div>
  </div>
</div>


<!-- View Mentors Modal -->
<div class="modal fade" id="viewMentorsModal" tabindex="-1" aria-labelledby="viewMentorsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewMentorsModalLabel">Assigned Mentors</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="endorserNameViewModal" class="fw-semibold mb-3 text-primary"></p>

        <form id="unassignForm">
          <div class="list-group" id="mentorsCheckboxList" style="max-height: 300px; overflow-y: auto;">
            <li class="list-group-item text-center text-muted">Loading...</li>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="unassignSelected">Unassign Selected</button>
      </div>
    </div>
  </div>
</div>




<!-- JS -->

<script>
  $(function () {
    $('#endorsersTable').DataTable();

    // Assign button setup
    $('.assign-btn').on('click', function () {
      const id = $(this).data('endorser');
      const name = $(this).data('endorser-name');
      $('#endorserId').val(id);
      $('#endorserNameModal').text(`Assign mentors for: ${name}`);

      // clear all previous selections
      $('#mentorCheckboxList input[type="checkbox"]').prop('checked', false);
    });

    // Save assignment
    $('#saveAssignment').on('click', function () {
      const endorserId = $('#endorserId').val();
      const selectedMentors = [];

      $('#mentorCheckboxList input[name="mentor_ids"]:checked').each(function () {
        selectedMentors.push($(this).val());
      });

      if (selectedMentors.length === 0) {
        alert('Please select at least one mentor.');
        return;
      }
      console.log("ENDORSE ID:", endorserId);
      console.log("MENTORS:", selectedMentors);
      $.ajax({
        url: "{% url 'assign_mentors' %}",
        method: "POST",
        data: {
          endorser_id: endorserId,              // correct variable
          mentor_ids: selectedMentors,          // correct variable
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.status === 'success') {
            alert('Mentors assigned successfully!');
            location.reload();
          } else {
            alert('Failed: ' + (response.message || 'Unknown error'));
          }
        },
        error: function (xhr) {
          alert('Error assigning mentors: ' + xhr.statusText);
        }
      });
    });


    // View mentors dynamically via AJAX
    $('.view-mentors-btn').on('click', function () {
      const endorserId = $(this).data('endorser');
      const endorserName = $(this).data('endorser-name');
      $('#endorserNameViewModal').text(`Mentors assigned to: ${endorserName}`);
      $('#mentorsCheckboxList').html('<li class="list-group-item text-center text-muted">Loading...</li>');
      $('#unassignSelected').data('endorser', endorserId);

      $.get("{% url 'get_assigned_mentors' %}", { endorser_id: endorserId }, function (data) {
        const list = $('#mentorsCheckboxList');
        list.empty();

        if (!data.mentors || data.mentors.length === 0) {
          list.append('<li class="list-group-item text-center text-muted">No mentors assigned</li>');
        } else {
          data.mentors.forEach(m => {
            list.append(`
            <label class="list-group-item d-flex align-items-center">
              <input class="form-check-input me-2" type="checkbox" name="mentor_ids" value="${m.id}">
              ${m.first_name} ${m.last_name}
              <span class="text-muted ms-auto small">(${m.email})</span>
            </label>
          `);
          });
        }
      }).fail(() => {
        $('#mentorsCheckboxList').html('<li class="list-group-item text-danger text-center">Error loading mentors</li>');
      });
    });

    // Unassign selected mentors
    $('#unassignSelected').on('click', function () {
      const endorserId = $(this).data('endorser');
      const mentorsToUnassign = [];
      $('#mentorsCheckboxList input[name="mentor_ids"]:checked').each(function () {
        mentorsToUnassign.push($(this).val());
      });

      if (mentorsToUnassign.length === 0) {
        alert('Select at least one mentor to unassign.');
        return;
      }

      $.ajax({
        url: "{% url 'unassign_mentor' %}",
        method: "POST",
        data: {
          endorser_id: endorserId,
          'mentor_ids[]': mentorsToUnassign,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function () {
          alert('Selected mentors unassigned successfully!');

          // Refresh the modal mentors list
          $(`.view-mentors-btn[data-endorser="${endorserId}"]`).click();

          // Update mentor count dynamically in the table
          const countCell = $(`button.view-mentors-btn[data-endorser="${endorserId}"]`)
            .closest('tr')
            .find('td:nth-child(3)'); // 3rd column = mentor count

          // Get the current count and decrease it by number of unassigned mentors
          const currentCount = parseInt(countCell.text().trim()) || 0;
          const newCount = Math.max(currentCount - mentorsToUnassign.length, 0);

          countCell.text(newCount);
        },

        error: function () {
          alert('Error unassigning mentors.');
        }
      });
    });
  });


</script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



{% endblock %}